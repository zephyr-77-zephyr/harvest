{% extends "base.html" %}
{% block title %}Your Cart | Harvest Helper{% endblock %}

{% block extra_head %}
<script>
  function updateCheckoutButton() {
    const checkboxes = document.querySelectorAll('input[name="selected_items"]:checked');
    const checkoutButton = document.getElementById('checkout-button');
    const totalPriceElement = document.getElementById('total-price');
    const selectedCountElement = document.getElementById('selected-count');
    
    let total = 0;
    let totalItems = 0;
    
    checkboxes.forEach(checkbox => {
      const price = parseFloat(checkbox.dataset.price);
      const quantity = parseInt(checkbox.dataset.quantity);
      total += price * quantity;
      totalItems += quantity;
    });
    
    totalPriceElement.textContent = '₱' + total.toFixed(2);
    selectedCountElement.textContent = totalItems;
    checkoutButton.disabled = checkboxes.length === 0;
  }

  function selectAllItems(selectAllCheckbox) {
    const checkboxes = document.querySelectorAll('input[name="selected_items"]');
    checkboxes.forEach(checkbox => {
      checkbox.checked = selectAllCheckbox.checked;
    });
    updateCheckoutButton();
  }
</script>
{% endblock %}

{% block content %}
  <h1 class="text-3xl font-bold text-soil mb-4">Shopping Cart</h1>
  <form method="post" action="{% url 'checkout' %}" id="cart-form">
    {% csrf_token %}
    <div class="bg-white rounded-3xl shadow divide-y">
      <div class="p-4 flex items-center border-b">
        <input type="checkbox" id="select-all" onchange="selectAllItems(this)" class="h-5 w-5 text-leaf rounded border-gray-300">
        <label for="select-all" class="ml-2 text-sm font-medium text-gray-700">Select all items</label>
      </div>
      
      {% for item in items %}
        <div class="p-4 flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
          <div class="flex items-center">
            <input type="checkbox" 
                   name="selected_items" 
                   value="{{ item.id }}" 
                   data-price="{{ item.product.price }}" 
                   data-quantity="{{ item.quantity }}"
                   onchange="updateCheckoutButton()"
                   class="h-5 w-5 text-leaf rounded border-gray-300 mr-3">
            <div>
              <p class="font-semibold text-soil">{{ item.product.name }}</p>
              <p class="text-sm text-gray-500">₱{{ item.product.price }} · {{ item.product.category.name }}</p>
            </div>
          </div>
          <div class="flex items-center gap-2">
            <input type="number" 
                   value="{{ item.quantity }}" 
                   class="w-20 rounded-xl border-gray-200 bg-gray-100" 
                   disabled />
          </div>
          <div class="text-right">
            <p class="font-semibold text-sunset">₱{{ item.subtotal }}</p>
            <a href="{% url 'remove_cart_item' item_id=item.id %}" class="text-sm text-red-500">Remove</a>
          </div>
        </div>
      {% empty %}
        <p class="p-6 text-center text-gray-500">Your cart is empty.</p>
      {% endfor %}
    </div>
    
    {% if items %}
      <div class="mt-6 flex flex-col gap-4 md:flex-row md:items-center md:justify-between">
        <div>
          <p class="text-xl font-bold text-soil">
            Selected Total: <span id="total-price">₱0.00</span>
          </p>
          <p class="text-sm text-gray-500">Cart Total: ₱{{ cart.total_price }}</p>
        </div>
        <button 
          type="submit" 
          id="checkout-button"
          class="w-full md:w-auto px-6 py-3 bg-soil text-white rounded-full font-semibold text-center hover:bg-soil/90 disabled:opacity-50 disabled:cursor-not-allowed"
          disabled>
          Proceed to checkout (<span id="selected-count">0</span> items)
        </button>
      </div>
    {% endif %}
  </form>
  
  <script>
    // Initialize the checkout button state
    document.addEventListener('DOMContentLoaded', function() {
      updateCheckoutButton();
    });
  </script>
{% endblock %}

